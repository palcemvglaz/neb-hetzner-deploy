#!/bin/bash

# Nebachiv Content App - Enhanced Development Startup Script
# Incorporates best practices from my-finance-app start.sh
# Features: Terminal titles, health checks, detailed logging, error handling

# Terminal title update function
update_terminal() {
    echo -ne "\033]0;$1\007"
}

# Error handler with terminal update
handle_error() {
    update_terminal "üî¥ Nebachiv Start - Failed"
    echo "‚ùå Error occurred during startup. Check the logs above."
    
    # Cleanup any started services
    cleanup
    exit 1
}

# Set error trap
trap 'handle_error' ERR

# Initial terminal title
update_terminal "üü° Nebachiv Start - Initializing"
echo "üöÄ Starting Nebachiv Content App development environment..."
echo "$(date '+%Y-%m-%d %H:%M:%S') - Startup initiated" >> startup.log

# Configuration
PORT=3205
PRISMA_PORT=5555
MAX_ATTEMPTS=30
DB_FILE="./prisma/dev.db"
HEALTH_CHECK_SCRIPT="./health-check.js"

# Check if running from correct directory
if [ ! -f "package.json" ] || [ ! -d "prisma" ]; then
    update_terminal "üî¥ Nebachiv Start - Wrong Directory"
    echo "‚ùå Please run this script from the project root directory"
    exit 1
fi

# Load environment variables if available
if [ -f ".env" ]; then
    export $(cat .env | grep -v '^#' | xargs)
fi

# PID file paths
NEXTJS_PID_FILE=".nextjs.pid"
PRISMA_PID_FILE=".prisma.pid"

# Cleanup function with comprehensive shutdown
cleanup() {
    echo ""
    update_terminal "üü° Nebachiv Start - Shutting Down"
    echo "üõë Stopping services..."
    
    # Stop Next.js if running
    if [ -f "$NEXTJS_PID_FILE" ]; then
        NEXTJS_PID=$(cat $NEXTJS_PID_FILE)
        if kill -0 $NEXTJS_PID 2>/dev/null; then
            echo "Stopping Next.js (PID: $NEXTJS_PID)..."
            kill $NEXTJS_PID 2>/dev/null || true
        fi
        rm -f $NEXTJS_PID_FILE
    fi
    
    # Stop Prisma Studio if running
    if [ -f "$PRISMA_PID_FILE" ]; then
        PRISMA_PID=$(cat $PRISMA_PID_FILE)
        if kill -0 $PRISMA_PID 2>/dev/null; then
            echo "Stopping Prisma Studio (PID: $PRISMA_PID)..."
            kill $PRISMA_PID 2>/dev/null || true
        fi
        rm -f $PRISMA_PID_FILE
    fi
    
    # Clean up any orphaned processes on our ports
    ./scripts/safe-process-killer.sh $PORT 2>/dev/null || true
    ./scripts/safe-process-killer.sh $PRISMA_PORT 2>/dev/null || true
    
    update_terminal "‚úÖ Nebachiv Start - Stopped"
    echo "‚úÖ All services stopped."
    echo "$(date '+%Y-%m-%d %H:%M:%S') - Shutdown complete" >> startup.log
    exit 0
}

# Set interrupt trap for clean shutdown
trap cleanup INT TERM

# Check dependencies
update_terminal "üü° Nebachiv Start - Checking Dependencies"
echo "üì¶ Checking dependencies..."

if [ ! -d "node_modules" ]; then
    echo "Installing dependencies..."
    npm install || handle_error
fi

# Use safe process killer
update_terminal "üü° Nebachiv Start - Port Check"
echo "üõ°Ô∏è  Using safe process killer to check ports..."
./scripts/safe-process-killer.sh $PORT || handle_error
./scripts/safe-process-killer.sh $PRISMA_PORT || true  # Prisma port is optional

# Database initialization
update_terminal "üü° Nebachiv Start - Database Setup"
if [ ! -f "$DB_FILE" ]; then
    echo "üìä Database not found. Initializing database..."
    npm run db:push || handle_error
    echo "üå± Seeding database with initial data..."
    npm run db:seed || handle_error
else
    echo "‚úÖ Database exists at $DB_FILE"
    
    # Run migrations if any pending
    echo "üîÑ Checking for pending migrations..."
    npm run db:push 2>&1 | grep -v "already in sync" || true
fi

# Start Prisma Studio
update_terminal "üü° Nebachiv Start - Prisma Studio"
echo "üóÑÔ∏è  Starting Prisma Studio (database GUI)..."
npm run db:studio > prisma-studio.log 2>&1 &
PRISMA_PID=$!
echo $PRISMA_PID > $PRISMA_PID_FILE
echo "Prisma Studio started with PID: $PRISMA_PID"

# Give Prisma Studio time to start
sleep 3

# Verify Prisma Studio is running
if ! kill -0 $PRISMA_PID 2>/dev/null; then
    echo "‚ö†Ô∏è  Prisma Studio failed to start. Check prisma-studio.log"
    # Continue anyway, it's not critical
fi

# Start Next.js development server
update_terminal "üü° Nebachiv Start - Next.js Server"
echo "üîß Starting Next.js development server on port $PORT..."
npm run dev > nextjs.log 2>&1 &
NEXTJS_PID=$!
echo $NEXTJS_PID > $NEXTJS_PID_FILE
echo "Next.js started with PID: $NEXTJS_PID"

# Wait for Next.js to be ready with retry logic
echo "‚è≥ Waiting for Next.js to compile and start..."
NEXTJS_READY=false
ATTEMPTS=0

while [ $ATTEMPTS -lt $MAX_ATTEMPTS ]; do
    if curl -s http://localhost:$PORT > /dev/null 2>&1; then
        NEXTJS_READY=true
        break
    fi
    
    # Check if process is still running
    if ! kill -0 $NEXTJS_PID 2>/dev/null; then
        update_terminal "üî¥ Nebachiv Start - Next.js Failed"
        echo "‚ùå Next.js process died. Check nextjs.log for errors"
        tail -20 nextjs.log
        handle_error
    fi
    
    echo "Waiting for Next.js... ($((ATTEMPTS+1))/$MAX_ATTEMPTS)"
    sleep 2
    ATTEMPTS=$((ATTEMPTS+1))
done

if [ "$NEXTJS_READY" = false ]; then
    update_terminal "üî¥ Nebachiv Start - Timeout"
    echo "‚ùå Next.js failed to start within timeout"
    tail -20 nextjs.log
    handle_error
fi

# Run comprehensive health check
update_terminal "üü° Nebachiv Start - Health Check"
echo ""
echo "üîç Running comprehensive health check..."

if [ -f "$HEALTH_CHECK_SCRIPT" ]; then
    node $HEALTH_CHECK_SCRIPT || echo "‚ö†Ô∏è  Some health checks failed, but continuing..."
else
    echo "‚ö†Ô∏è  Health check script not found, skipping..."
fi

# Get local IP for mobile testing
LOCAL_IP=$(ipconfig getifaddr en0 2>/dev/null || echo "Not available")

# Success! Update terminal and show summary
update_terminal "‚úÖ Nebachiv Start - All Running"
echo ""
echo "üéâ All services started successfully!"
echo "$(date '+%Y-%m-%d %H:%M:%S') - All services running" >> startup.log
echo ""
echo "üìã Services running:"
echo "   ‚Ä¢ Next.js App: http://localhost:$PORT"
echo "   ‚Ä¢ API Health: http://localhost:$PORT/api/health"
echo "   ‚Ä¢ Prisma Studio: http://localhost:$PRISMA_PORT"
echo "   ‚Ä¢ KB_NEB Vault: /Users/chyngys/scripts/kb_neb/vault_output"
echo ""
echo "üì± Mobile Testing (same Wi-Fi network):"
echo "   ‚Ä¢ Mobile URL: http://$LOCAL_IP:$PORT"
echo "   ‚Ä¢ Dashboard: http://$LOCAL_IP:$PORT/dashboard"
echo "   ‚Ä¢ Courses: http://$LOCAL_IP:$PORT/courses"
echo ""
echo "üìç Available URLs & Endpoints:"
echo ""
echo "   üåê Main Pages:"
echo "      ‚Ä¢ Home: http://localhost:$PORT"
echo "      ‚Ä¢ Dashboard: http://localhost:$PORT/dashboard"
echo "      ‚Ä¢ Courses: http://localhost:$PORT/courses"
echo "      ‚Ä¢ Login: http://localhost:$PORT/login"
echo ""
echo "   üîß API Endpoints:"
echo "      ‚Ä¢ Health: http://localhost:$PORT/api/health"
echo "      ‚Ä¢ Courses: http://localhost:$PORT/api/courses"
echo "      ‚Ä¢ KB_NEB Sync: http://localhost:$PORT/api/kb-neb/sync"
echo "      ‚Ä¢ Auth: http://localhost:$PORT/api/auth"
echo "      ‚Ä¢ Stripe: http://localhost:$PORT/api/stripe"
echo ""
echo "   üë• Role-Based Pages:"
echo "      ‚Ä¢ Admin Panel: http://localhost:$PORT/admin"
echo "      ‚Ä¢ Instructor: http://localhost:$PORT/instructor"
echo "      ‚Ä¢ School: http://localhost:$PORT/school"
echo ""
echo "   üß™ Test Pages:"
echo "      ‚Ä¢ Google OAuth Test: http://localhost:$PORT/test-google"
echo "      ‚Ä¢ Skill Test: http://localhost:$PORT/test-skill"
echo ""
echo "üìÑ Log files:"
echo "   ‚Ä¢ Next.js: nextjs.log"
echo "   ‚Ä¢ Prisma Studio: prisma-studio.log"
echo "   ‚Ä¢ Startup events: startup.log"
echo "   ‚Ä¢ Enhanced logs: /logs directory"
echo ""
echo "üõ†Ô∏è  Quick commands:"
echo "   ‚Ä¢ Health check: node health-check.js"
echo "   ‚Ä¢ Test all pages: node test-all-pages.js"
echo "   ‚Ä¢ Deep check: node deep-health-check.js"
echo "   ‚Ä¢ KB_NEB sync: npm run kb-neb:sync"
echo "   ‚Ä¢ View logs: tail -f nextjs.log"
echo "   ‚Ä¢ Terminal title: ./scripts/set-terminal-title.sh [status] [area] [task]"
echo ""
echo "üí° Tips:"
echo "   ‚Ä¢ Use the 3-level health check system regularly"
echo "   ‚Ä¢ Check enhanced logs in /logs directory for debugging"
echo "   ‚Ä¢ Update terminal title to track your work status"
echo ""
echo "üì± Mobile App Installation:"
echo "   ‚Ä¢ iOS: Open http://$LOCAL_IP:$PORT in Safari ‚Üí Share ‚Üí Add to Home Screen"
echo "   ‚Ä¢ Android: Open http://$LOCAL_IP:$PORT in Chrome ‚Üí Menu ‚Üí Add to home screen"
echo "   ‚Ä¢ Or use ngrok for external access: ngrok http $PORT"
echo ""
echo "Press Ctrl+C to stop all services safely"

# Start error watcher in new terminal (by default)
echo ""
echo "üîç Starting Error Watcher in new terminal..."
if command -v osascript &> /dev/null; then
    # macOS - open new terminal with error watcher
    osascript -e 'tell app "Terminal" to do script "cd '"$(pwd)"' && node error-watcher.js"'
    echo "‚úÖ Error Watcher started in new terminal window"
else
    # Linux/other - start in background
    node error-watcher.js > error-watcher.log 2>&1 &
    ERROR_WATCHER_PID=$!
    echo $ERROR_WATCHER_PID > $ERROR_WATCHER_PID_FILE
    echo "‚úÖ Error Watcher started in background (PID: $ERROR_WATCHER_PID)"
    echo "   View logs: tail -f error-watcher.log"
fi

# Option to disable error watcher
if [[ "$1" == "--no-watcher" ]] || [[ "$1" == "-nw" ]]; then
    echo "‚è≠Ô∏è  Skipping Error Watcher (use ./start.sh to enable)"
    if [ -f "$ERROR_WATCHER_PID_FILE" ]; then
        kill $(cat $ERROR_WATCHER_PID_FILE) 2>/dev/null || true
        rm -f $ERROR_WATCHER_PID_FILE
    fi
fi

# Optional: Start additional services
if [ -f "./scripts/auto-backup.sh" ]; then
    echo "üîÑ Starting auto-backup service..."
    ./scripts/auto-backup.sh start > /dev/null 2>&1 || echo "‚ö†Ô∏è  Auto-backup not available"
fi

# Keep script running and monitor services
while true; do
    # Check if main services are still running
    if [ -f "$NEXTJS_PID_FILE" ] && ! kill -0 $(cat $NEXTJS_PID_FILE) 2>/dev/null; then
        update_terminal "üî¥ Nebachiv Start - Next.js Crashed"
        echo "‚ùå Next.js process crashed! Check nextjs.log"
        tail -20 nextjs.log
        handle_error
    fi
    
    # Sleep for monitoring interval
    sleep 10
done